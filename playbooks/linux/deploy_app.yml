---
- name: Deploy Application on Linux / LinuxONE
  hosts: linux
  become: yes

  vars:
    app_name: "bankapp"
    app_user: "appuser"
    app_dir: "/opt/{{ app_name }}"
    app_port: 8080
    app_package: "app.tar.gz"

  tasks:

    - name: Ensure application user exists
      user:
        name: "{{ app_user }}"
        shell: /bin/bash
        create_home: no
        state: present

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Copy application package
      copy:
        src: "../files/{{ app_package }}"
        dest: "{{ app_dir }}/{{ app_package }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'

    - name: Extract application package
      unarchive:
        src: "{{ app_dir }}/{{ app_package }}"
        dest: "{{ app_dir }}"
        remote_src: yes
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Deploy systemd service
      template:
        src: "../templates/app.service.j2"
        dest: "/etc/systemd/system/{{ app_name }}.service"
        mode: '0644'

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Start and enable application service
      systemd:
        name: "{{ app_name }}"
        state: restarted
        enabled: yes

    - name: Validate service status
      systemd:
        name: "{{ app_name }}"
        state: started
      register: service_status

    - name: Show deployment result
      debug:
        msg: "Application {{ app_name }} deployed successfully."
